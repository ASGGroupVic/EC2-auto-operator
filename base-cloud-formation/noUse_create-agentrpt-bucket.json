{
  "AWSTemplateFormatVersion": "2010-09-09",
  "Description": "S3 Bucket For resi data",
  "Parameters": {
    "bucketName": {
      "Type": "String"
    },
    "richmondOfficeIp": {
      "Default": "203.17.253.249/32",
      "Type": "String"
    },
    "EmailAddress": {
      "Default": "resi-data-dev@rea-group.com",
      "Type": "String"
    }
  },
  "Resources": {
    "S3Bucket": {
      "Properties": {
        "AccessControl": "BucketOwnerFullControl",
        "BucketName": {
          "Ref": "bucketName"
        },
        "LifecycleConfiguration": {
          "Rules": [
            {
              "Id": "30 days log objects expire rule",
              "ExpirationInDays": 30,
              "Status": "Enabled",
              "Prefix": "logs/"
            },
            {
              "Id": "3 years input raw data expire rule",
              "ExpirationInDays": 1095,
              "Status": "Enabled",
              "Prefix": "input/",
              "Transition": {
                "StorageClass": "Glacier",
                "TransitionInDays": "180"
               }
            }
          ]
        },
        "Tags": [
          {
            "Key": "application",
            "Value": "Resi Data Store"
          },
          {
            "Key": "contact",
            "Value":  {"Ref": "EmailAddress"}
          },
          {
            "Key": "lob",
            "Value": "Resi Data Analytics"
          }
        ]
      },
      "Type": "AWS::S3::Bucket"
    },
    "S3BucketPolicy": {
      "DependsOn": [
        "S3Bucket"
      ],
      "Properties": {
        "Bucket": {
          "Ref": "S3Bucket"
        },
        "PolicyDocument": {
          "Statement": [
            {
              "Action": [
                "s3:DeleteBucketPolicy",
                "s3:DeleteObject",
                "s3:DeleteObjectVersion",
                "s3:PutBucketAcl",
                "s3:PutBucketLogging",
                "s3:PutBucketPolicy",
                "s3:PutBucketVersioning",
                "s3:PutLifecycleConfiguration",
                "s3:PutObjectAcl",
                "s3:PutObjectVersionAcl"
              ],
              "Condition": {
                "IpAddress": {
                  "aws:SourceIp": {
                    "Ref": "richmondOfficeIp"
                  }
                }
              },
              "Effect": "Allow",
              "Principal": {
                "AWS": [
                  {
                    "Fn::Join": [
                      "",
                      [
                        "arn:aws:iam::",
                        {
                          "Ref": "AWS::AccountId"
                        },
                        ":root"
                      ]
                    ]
                  }
                ]
              },
              "Resource": [
                {
                  "Fn::Join": [
                    "",
                    [
                      "arn:aws:s3:::",
                      {
                        "Ref": "bucketName"
                      }
                    ]
                  ]
                },
                {
                  "Fn::Join": [
                    "",
                    [
                      "arn:aws:s3:::",
                      {
                        "Ref": "bucketName"
                      },
                      "/*"
                    ]
                  ]
                }
              ],
              "Sid": "only-allow-rea-ip-to-change-bucket-policies"
            }
          ],
          "Version": "2012-10-17"
        }
      },
      "Type": "AWS::S3::BucketPolicy"
    }
  }
}
