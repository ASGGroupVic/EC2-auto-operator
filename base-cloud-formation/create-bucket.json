{
  "AWSTemplateFormatVersion":"2010-09-09",
  "Description":"S3 Buckets for Resi Data Analytics",
  "Parameters":{
    "amiRegisterBucketName":{
      "Description":"Name of S3 bucket for registered AMIs",
      "Type":"String"
    },
    "dockerBucketName":{
      "Description":"Name of S3 bucket for resi data docker stuffs",
      "Type":"String",
      "Default":"rea-residata-dev-docker"
    },
    "agentReportBucketName":{
      "Description":"Name of S3 bucket for residata agent reports",
      "Type":"String",
      "Default":"agent-rpt-dev"
    },
    "elasticLoadBalancingBucketName":{
      "Description":"Name of S3 bucket for elb logs",
      "Type":"String",
      "Default":"rea-residata-dev-elb"
    },
    "EmailAddress": {
      "Description":"Name of S3 bucket contract info",
      "Default": "resi-data-dev@rea-group.com",
      "Type": "String"
    }
  },
  "Resources":{
    "AmiRegisterBucket":{
      "Type":"AWS::S3::Bucket",
      "Properties":{
        "AccessControl":"Private",
        "BucketName":{
          "Ref":"amiRegisterBucketName"
        },
        "Tags":[
          {
            "Key":"contact",
            "Value":{"Ref": "EmailAddress"}
          }
        ]
      }
    },
    "AmiRegisterBucketPolicy":{
      "Type":"AWS::S3::BucketPolicy",
      "Properties":{
        "Bucket":{
          "Ref":"AmiRegisterBucket"
        },
        "PolicyDocument":{
          "Statement":[
            {
              "Principal":{
                "AWS":[
                  "arn:aws:iam::177242442824:root"
                ]
              },
              "Action":[
                "s3:Get*",
                "s3:List*"
              ],
              "Effect":"Allow",
              "Resource":[
                {
                  "Fn::Join":[
                    "",
                    [
                      "arn:aws:s3:::",
                      {
                        "Ref":"amiRegisterBucketName"
                      }
                    ]
                  ]
                },
                {
                  "Fn::Join":[
                    "",
                    [
                      "arn:aws:s3:::",
                      {
                        "Ref":"amiRegisterBucketName"
                      },
                      "/*"
                    ]
                  ]
                }
              ]
            }
          ]
        }
      }
    },
    "DockerBucket":{
      "Type":"AWS::S3::Bucket",
      "Properties":{
        "AccessControl":"Private",
        "BucketName":{
          "Ref":"dockerBucketName"
        },
        "Tags":[
          {
            "Key":"contact",
            "Value":{"Ref": "EmailAddress"}
          }
        ]
      }
    },
    "ElasticLoadBalancingBucket":{
      "Type":"AWS::S3::Bucket",
      "Properties":{
        "AccessControl":"Private",
        "BucketName":{
          "Ref":"elasticLoadBalancingBucketName"
        },
        "VersioningConfiguration":{
          "Status":"Enabled"
        }
      }
    },
    "ElasticLoadBalancingBucketPolicy":{
      "Type":"AWS::S3::BucketPolicy",
      "Metadata":{
        "783225319266":"ELB Account ID for Sydney",
        "177242442824":"Residata Dev"
      },
      "Properties":{
        "Bucket":{
          "Ref":"ElasticLoadBalancingBucket"
        },
        "PolicyDocument":{
          "Statement":[
            {
              "Principal":{
                "AWS":"arn:aws:iam::783225319266:root"
              },
              "Action":"s3:Put*",
              "Effect":"Allow",
              "Resource":[
                {
                  "Fn::Join":[
                    "",
                    [
                      "arn:aws:s3:::",
                      {
                        "Ref":"elasticLoadBalancingBucketName"
                      }
                    ]
                  ]
                },
                {
                  "Fn::Join":[
                    "",
                    [
                      "arn:aws:s3:::",
                      {
                        "Ref":"elasticLoadBalancingBucketName"
                      },
                      "/*"
                    ]
                  ]
                }
              ]
            },
            {
              "Principal":{
                "AWS":[
                  "arn:aws:iam::177242442824:root"
                ]
              },
              "Action":[
                "s3:Get*",
                "s3:List*"
              ],
              "Effect":"Allow",
              "Resource":[
                {
                  "Fn::Join":[
                    "",
                    [
                      "arn:aws:s3:::",
                      {
                        "Ref":"elasticLoadBalancingBucketName"
                      }
                    ]
                  ]
                },
                {
                  "Fn::Join":[
                    "",
                    [
                      "arn:aws:s3:::",
                      {
                        "Ref":"elasticLoadBalancingBucketName"
                      },
                      "/*"
                    ]
                  ]
                }
              ]
            }
          ]
        }
      }
    },
    "AgentReportBucketName":{
      "Type":"AWS::S3::Bucket",
      "Properties":{
        "AccessControl":"Private",
        "BucketName":{
          "Ref":"agentReportBucketName"
        },
        "LifecycleConfiguration": {
          "Rules": [
            {
              "Id": "30 days log objects expire rule",
              "ExpirationInDays": 30,
              "Status": "Enabled",
              "Prefix": "logs/"
            },
            {
              "Id": "3 years input raw data expire rule",
              "ExpirationInDays": 1095,
              "Status": "Enabled",
              "Prefix": "input/",
              "Transition": {
                "StorageClass": "Glacier",
                "TransitionInDays": "180"
              }
            }
          ]
        },
        "Tags":[
          {
            "Key": "application",
            "Value": "Agent Reports"
          },
          {
            "Key": "contact",
            "Value":  {"Ref": "EmailAddress"}
          },
          {
            "Key": "lob",
            "Value": "Resi Data Analytics"
          }
        ]
      }
    },
    "AgentReportBucketNamePolicy":{
      "Type":"AWS::S3::BucketPolicy",
      "Metadata":{
        "177242442824":"Residata-Dev"
      },
      "DependsOn": [
        "AgentReportBucketName"
      ],
      "Properties":{
        "Bucket":{
          "Ref":"agentReportBucketName"
        },
        "PolicyDocument":{
          "Statement":[
            {
              "Principal":{
                "AWS":[
                  "arn:aws:iam::177242442824:root"
                ]
              },
              "Action":[
                "s3:Get*",
                "s3:List*"
              ],
              "Effect":"Allow",
              "Resource":[
                {
                  "Fn::Join":[
                    "",
                    [
                      "arn:aws:s3:::",
                      {
                        "Ref":"agentReportBucketName"
                      }
                    ]
                  ]
                },
                {
                  "Fn::Join":[
                    "",
                    [
                      "arn:aws:s3:::",
                      {
                        "Ref":"agentReportBucketName"
                      },
                      "/*"
                    ]
                  ]
                }
              ]
            }
          ]
        }
      }
    }
  }
}