{
  "AWSTemplateFormatVersion":"2010-09-09",
  "Description":"Common S3 Buckets for Resi Data Analytics",
  "Parameters":{
    "amiRegisterBucketName":{
      "Description":"Name of S3 bucket for registered AMIs",
      "Type":"String"
    },
    "agentReportBucketName":{
      "Description":"Name of S3 bucket for residata agent reports",
      "Type":"String"
    },
    "elasticLoadBalancingBucketName":{
      "Description":"Name of S3 bucket for elb logs",
      "Type":"String"
    },
    "EmailAddress": {
      "Description":"Name of S3 bucket contract info",
      "Type": "String"
    } ,
    "principalList": {
      "Description":"list of AWS AccountIDs that permitted access",
      "Type": "CommaDelimitedList"
    }
  },
  "Resources":{
    "AmiRegisterBucket":{
      "Type":"AWS::S3::Bucket",
      "Properties":{
        "AccessControl":"Private",
        "BucketName":{
          "Ref":"amiRegisterBucketName"
        },
        "Tags":[
          {
            "Key":"contact",
            "Value":{"Ref": "EmailAddress"}
          }
        ]
      }
    },
    "AmiRegisterBucketPolicy":{
      "Type":"AWS::S3::BucketPolicy",
      "DependsOn": [
        "AmiRegisterBucket"
      ],
      "Properties":{
        "Bucket":{
          "Ref":"amiRegisterBucketName"
        },
        "PolicyDocument":{
          "Statement":[
            {
              "Principal":{
                "AWS": {"Ref":"principalList"}
              },
              "Action":[
                "s3:Get*",
                "s3:List*"
              ],
              "Effect":"Allow",
              "Resource":[
                {
                  "Fn::Join":[
                    "",
                    [
                      "arn:aws:s3:::",
                      {
                        "Ref":"amiRegisterBucketName"
                      }
                    ]
                  ]
                },
                {
                  "Fn::Join":[
                    "",
                    [
                      "arn:aws:s3:::",
                      {
                        "Ref":"amiRegisterBucketName"
                      },
                      "/*"
                    ]
                  ]
                }
              ]
            }
          ]
        }
      }
    },
    "ElasticLoadBalancingBucket":{
      "Type":"AWS::S3::Bucket",
      "Properties":{
        "AccessControl":"Private",
        "BucketName":{
          "Ref":"elasticLoadBalancingBucketName"
        },
        "VersioningConfiguration":{
          "Status":"Enabled"
        }
      }
    },
    "ElasticLoadBalancingBucketPolicy":{
      "Type":"AWS::S3::BucketPolicy",
      "Metadata":{
        "783225319266":"ELB Account ID for Sydney",
        "177242442824":"Residata Dev",
        "563560393941":"Residata Prod"
      },
      "DependsOn": [
        "ElasticLoadBalancingBucket"
      ],
      "Properties":{
        "Bucket":{
          "Ref":"ElasticLoadBalancingBucket"
        },
        "PolicyDocument":{
          "Statement":[
            {
              "Principal":{
                "AWS":"arn:aws:iam::783225319266:root"
              },
              "Action":"s3:Put*",
              "Effect":"Allow",
              "Resource":[
                {
                  "Fn::Join":[
                    "",
                    [
                      "arn:aws:s3:::",
                      {
                        "Ref":"elasticLoadBalancingBucketName"
                      }
                    ]
                  ]
                },
                {
                  "Fn::Join":[
                    "",
                    [
                      "arn:aws:s3:::",
                      {
                        "Ref":"elasticLoadBalancingBucketName"
                      },
                      "/*"
                    ]
                  ]
                }
              ]
            },
            {
              "Principal":{
                "AWS":{"Ref":"principalList"}
              },
              "Action":[
                "s3:Get*",
                "s3:List*"
              ],
              "Effect":"Allow",
              "Resource":[
                {
                  "Fn::Join":[
                    "",
                    [
                      "arn:aws:s3:::",
                      {
                        "Ref":"elasticLoadBalancingBucketName"
                      }
                    ]
                  ]
                },
                {
                  "Fn::Join":[
                    "",
                    [
                      "arn:aws:s3:::",
                      {
                        "Ref":"elasticLoadBalancingBucketName"
                      },
                      "/*"
                    ]
                  ]
                }
              ]
            }
          ]
        }
      }
    },
    "AgentReportBucket":{
      "Type":"AWS::S3::Bucket",
      "Properties":{
        "AccessControl":"Private",
        "BucketName":{
          "Ref":"agentReportBucketName"
        },
        "LifecycleConfiguration": {
          "Rules": [
            {
              "Id": "30 days log objects expire rule",
              "ExpirationInDays": 30,
              "Status": "Enabled",
              "Prefix": "logs"
            }
          ]
        },
        "Tags":[
          {
            "Key": "application",
            "Value": "Agent Reports"
          },
          {
            "Key": "contact",
            "Value":  {"Ref": "EmailAddress"}
          },
          {
            "Key": "lob",
            "Value": "Resi Data Analytics"
          }
        ]
      }
    },
    "AgentReportBucketNamePolicy":{
      "Type":"AWS::S3::BucketPolicy",
      "DependsOn": [
        "AgentReportBucket"
      ],
      "Properties":{
        "Bucket":{
          "Ref":"agentReportBucketName"
        },
        "PolicyDocument":{
          "Statement":[
            {
              "Principal": {
                "AWS": {
                  "Fn::Join": [
                    "",
                    [
                      "arn:aws:iam::",
                      {
                        "Ref": "AWS::AccountId"
                      },
                      ":",
                      "root"
                    ]
                  ]
                }
              },
              "Action":[
                "s3:Get*",
                "s3:List*"
              ],
              "Effect":"Allow",
              "Resource":[
                {
                  "Fn::Join":[
                    "",
                    [
                      "arn:aws:s3:::",
                      {
                        "Ref":"agentReportBucketName"
                      }
                    ]
                  ]
                },
                {
                  "Fn::Join":[
                    "",
                    [
                      "arn:aws:s3:::",
                      {
                        "Ref":"agentReportBucketName"
                      },
                      "/*"
                    ]
                  ]
                }
              ]
            }
          ]
        }
      }
    }
  }
}